name: Build All Platforms

on:
  # تنظیمات برای اجرا روی تگ (ریلیز)
  push:
    tags:
      - "v*"

  # تنظیمات برای اجرای دستی با قابلیت انتخاب
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build for Windows'
        required: true
        default: true
        type: boolean
      build_ios:
        description: 'Build for iOS'
        required: true
        default: true
        type: boolean

jobs:
  # ==========================================
  # JOB 1: WINDOWS BUILD
  # ==========================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    # این شرط می‌گوید: اگر تگ زده شد (ریلیز) یا اگر دستی بود و تیک ویندوز زده شده بود، اجرا کن
    if: ${{ github.event_name == 'push' || github.event.inputs.build_windows == 'true' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install MinGW manually
        run: |
          choco install mingw -y --no-progress
          echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH

      - name: Build Library and Desktop Bin
        run: |
          python build/main.py windows

      - name: Prepare Artifacts
        run: |
          mkdir release_windows
          if (Test-Path windows_dll\libXray.dll) { copy windows_dll\libXray.dll release_windows\ }
          if (Test-Path windows_dll\libXray.h) { copy windows_dll\libXray.h release_windows\ }
          if (Test-Path bin\xray.exe) { copy bin\xray.exe release_windows\ }

      - name: Zip Windows Output
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: 'libXray-windows.zip'
          directory: 'release_windows'

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libXray-windows
          path: release_windows/libXray-windows.zip

      - name: Upload Windows to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release_windows/libXray-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # JOB 2: iOS BUILD
  # ==========================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    # شرط اجرا: اگر تگ بود یا اگر تیک iOS زده شده بود
    if: ${{ github.event_name == 'push' || github.event.inputs.build_ios == 'true' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25' # یکسان سازی با ویندوز
          check-latest: true

      - name: Install Gomobile Tool
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

      - name: Fix Dependencies (Force)
        run: |
          go get golang.org/x/mobile/bind

      - name: Build XCFramework for iOS
        run: |
          gomobile bind -target=ios -ldflags="-s -w" -o LibXray.xcframework .

      # برای iOS حتما باید زیپ کنیم چون XCFramework یک فولدر است نه یک فایل
      - name: Zip iOS Output
        run: |
          zip -r LibXray-ios.zip LibXray.xcframework

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LibXray-iOS
          path: LibXray-ios.zip

      - name: Upload iOS to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: LibXray-ios.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
