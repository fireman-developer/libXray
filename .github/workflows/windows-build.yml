name: Build Windows

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          check-latest: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install MinGW manually
        run: |
          # نصب MinGW بدون استفاده از اکشن egor-tensin که خطا داشت
          choco install mingw -y --no-progress
          # اضافه کردن مسیر باینری MinGW به متغیر محیطی PATH
          echo "C:\ProgramData\mingw64\mingw64\bin" >> $env:GITHUB_PATH

      - name: Verify GCC
        run: |
          # اطمینان از نصب صحیح
          gcc --version

      - name: Build Library and Desktop Bin
        run: |
          python build/main.py windows

      - name: Prepare Artifacts
        run: |
          mkdir release_output
          
          # کپی فایل‌های DLL و Header
          if (Test-Path windows_dll\libXray.dll) { copy windows_dll\libXray.dll release_output\ }
          if (Test-Path windows_dll\libXray.h) { copy windows_dll\libXray.h release_output\ }
          
          # کپی فایل اجرایی اگر وجود داشته باشد
          if (Test-Path bin\xray.exe) { copy bin\xray.exe release_output\ }

      - name: Zip Release
        uses: thedoctor0/zip-release@0.7.6
        with:
          type: 'zip'
          filename: 'libXray-windows.zip'
          directory: 'release_output'

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release_output/libXray-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (Fallback)
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: libXray-windows
          path: release_output/libXray-windows.zip
